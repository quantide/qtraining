---
title: "Grouping Data"
---

```{r options, include=FALSE, purl=FALSE}
options(width = 108)
```

```{r first, include=TRUE, purl=TRUE, message=FALSE}
# load packages and data
require(tidyverse)  # alternatively require(dplyr)
require(qdata)
data(bank)
```

# `group_by()`

The verb functions are useful, but they increase their power when combined with the idea of "group by", i.e. repeating the operation individually on groups of observations within the dataset.
In `dplyr`, you use the `group_by()` function to describe how to break a dataset down into groups of rows. You can then use the resulting object in the verbs functions; theyâ€™ll automatically work "by group" when the input is grouped. Let us see some examples (pay attention to objects class).

```{r grouped_df_class}
# Example data frame
df <- data.frame(x = 1:6, f = rep(1:2, each = 3))

# Grouped data frame
dff <- group_by(df, f)
dff
class(dff)

# Use dff (grouped data frame) as .data argument value in mutate() 
dffn <- mutate(.data = dff, n = n())
dffn
class(dffn)


# Use dff (grouped data frame) as .data argument value in arrange()
dffa <- arrange(.data = dff, desc(x))
dffa
class(dffa)


# Use dff (grouped data frame) as data argument value in summarise()
dfg <- summarise(.data = dff, x_avg = mean(x))
dfg
class(dfg)
```

In the following example, you split the complete dataset into years and then summarise each year by counting the number of phone calls (`count = n()`) and computing the average duration call (`mean_duration = mean(duration, na.rm = TRUE)`) and balance (`mean_balance = mean(balance, na.rm = TRUE)`):

```{r}
by_year <- group_by(bank, year)
summarise(by_year,
          count = n(),
          mean_duration = mean(duration, na.rm = TRUE),
          mean_balance = mean(balance, na.rm = TRUE))
```

<!-- AS comment on tables --->

<!--
```{r}
dm <- mtcars %>% 
  group_by(cyl, carb) %>%
  summarise(mpg_mean = mean(mpg))


tapply(dm$mpg_mean, list(dm$cyl, dm$carb), FUN = I)

with(dm, tapply(mpg_mean, list(cyl, carb), FUN = I))

require(xtable)
xtabs(mpg_mean~cyl+carb, data = dm)

```
-->

Then, you search for the number of days covered per year. You also report  the number of phone calls per year:

```{r}
summarise(by_year,
          days = n_distinct(date),
          count = n())
```

When you group by multiple variables, each summary peels off one level of the grouping. That makes it easy to progressively roll up a dataset:

```{r}
daily <- group_by(bank, year, month, day)
groups(daily)

per_day <- summarise(daily, calls = n())
groups(per_day)

per_month <- summarise(per_day, calls = sum(calls))
groups(per_month)

per_year <- summarise(per_month, calls = sum(calls))
groups(per_year)
```


```{r}
df <- data.frame(year = rep(c(2014, 2015, 2016), each = 3), 
                 month = rep(1:3, each = 3), 
                 day = rep(20:22, 3), 
                 x = 1:9)

df

df1 <- df %>% group_by(year, month, day) 

groups(df1)

df2 <-  df1 %>% 
  summarise(x_avg = mean(x), n = n())

df2

groups(df2)

summarise(df2, n())

ungroup(df2) %>% summarise(n())

```


In all the above steps (grouping and the summarising), you saved the intermediate results in a separate data frame. 

Suppose you want to calculate the mean balance grouped by marital status. If you save all the intermediate dataframes:

```{r}
bank_grouped <- bank %>% 
  group_by(marital)       # group by marital status

bank_grouped %>% 
  summarise(mean(balance))   # calculate the group means
```

If you do not want to save the intermediate results you may choose between one of the two options:


```{r}
# option 1:
summarise(group_by(bank, marital), mean(balance))

# option 2:
bank %>% 
  group_by(marital) %>%       # group by marital status
  summarise(mean(balance))    # calculate the group means
```

The two options provide the same results. However, in option 1 you read the operations inside out: first you group (inside) and secondly you summarise. If you use the `%>%` operator, you can easily get around this problem. You can better appreciate it in the following example, where we use three verbs on the grouped data frame:


```{r}
# option 1
filter(
  summarise(
    select(
      group_by(bank, date), age, balance
    ),
    mean_age = mean(age, na.rm = TRUE),
    mean_balance = mean(balance, na.rm = TRUE)
  ),
  mean_age < 40 & mean_balance > 5000
)

# option 2
bank %>%
  group_by(date) %>%
  select(age, balance) %>%
  summarise(
    mean_age = mean(age, na.rm = TRUE),
    mean_balance = mean(balance, na.rm = TRUE)
  ) %>%
  filter(mean_age < 40 & mean_balance > 5000)
```


