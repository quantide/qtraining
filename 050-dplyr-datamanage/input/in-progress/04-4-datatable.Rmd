---
title: ' data.table backend for dplyr: data.table'
---

```{r options, include=FALSE, purl=FALSE}
require(knitr)
options(width = 108)
```

```{r first, include=TRUE, purl=TRUE, message=FALSE}
# load packages
require(tidyverse)
require(rbenchmark)
require(data.table)  
```

## data.table

`data.table` is a data object for fast aggregation of large data (e.g. 100GB in RAM), fast ordered joins, fast add/modify/delete of columns, a fast file reader and parallel file writer. Its syntax is however a bit complicated and very different from dplyr. 

Suppose you want to import a quite large data file (for example, consider one of the .csv files on flights data). Using the data.table format:

```{r}
data2006 <- fread("~/data/2006.csv")
is.data.table(data2006)    
```

which is quite fast:

```{r}
system.time(fread("~/data/2006.csv"))
```

compared to the functions in `readr`:

```{r example dplyr}
data2006_tbl <- read_csv("~/data/2006.csv")
system.time(read_csv("~/data/2006.csv"))
```


So far the syntax in data.table is not that much different as compared to the dplyr syntax. However, let us make this slightly more complicated:


```{r}
# with data.table
benchmark(replications= 10, columns = c("elapsed"), 
          data2006[, mean(ArrDelay, na.rm = TRUE), keyby = Month])

# with dplyr
benchmark(replications= 10, columns = c("elapsed"), data2006 %>%
            group_by(Month) %>% 
            summarise(mean(ArrDelay, na.rm = TRUE)))
```


Notice that `dplyr` functions run on data.tables, as well as on tibbles and data frames.

The data.table syntax quickly gets more and more complicated. Suppose you want to apply two functions, for instance mean and standard deviation, to one variable:

```{r}
# with data.table
benchmark(replications= 10, columns = c("elapsed"), 
          data2006[, list(mean(ArrDelay, na.rm = TRUE), sd(ArrDelay, na.rm=TRUE)), keyby = Month]
  )

# with dplyr
benchmark(replications= 10, columns = c("elapsed"), 
          data2006 %>% 
            group_by(Month) %>% 
            summarise_each(funs(mean(., na.rm = TRUE), sd(., na.rm = TRUE)), ArrDelay)
  )
```

and now two functions on two variables:

```{r}
# with data.table
benchmark(replications= 10, columns = c("elapsed"),
          data2006[, list(mean(ArrDelay, na.rm = TRUE), sd(ArrDelay, na.rm=TRUE),
                  mean(Distance, na.rm = TRUE), sd(Distance, na.rm=TRUE)), keyby = Month]
  )

# with dplyr
benchmark(replications= 10, columns = c("elapsed"),
          data2006 %>% 
            group_by(Month) %>% 
            summarise_at(vars(ArrDelay, Distance), funs(mean(., na.rm = TRUE), sd(., na.rm = TRUE)))
  )
```

`data.table` is thus faster than `dplyr`, but its syntax is much more complicated.

