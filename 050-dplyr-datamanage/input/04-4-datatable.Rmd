---
title: " data.table backend for dplyr: data.table"
---

```{r options, include=FALSE, purl=FALSE}
options(width = 108)
```

```{r first, include=TRUE, purl=TRUE, message=FALSE}
# load packages
require(tidyverse) # alternatively: require(dplyr); require(ggplot2)
require(data.table)  
```

## data.table

`data.table` is a data object for fast aggregation of large data (e.g. 100GB in RAM), fast ordered joins, fast add/modify/delete of columns, a fast file reader and parallel file writer. Its syntax is however a bit complicated and very different from dplyr. 

Suppose you want to import a quite large data file (for example, consider one of the .csv files on flights data). Using the data.table format:

```{r}
data2006 <- fread("file:///home/emanuela/ema/sp-data/2006.csv")
is.data.table(data2006)    # imports in data.table format
data2006     # prints first 5 and last 5 rows
```

which is quite fast

```{r}
system.time(fread("file:///home/emanuela/ema/sp-data/2006.csv"))
```

compared to the functions in `readr`:

```{r example dplyr}
system.time(read_csv("/home/emanuela/ema/sp-data/2006.csv"))
```


So far the syntax in data.table is not that much different as compared to the dplyr syntax. However, let us make this slightly more complicated:


```{r}
# with data.table
system.time(data2006[, mean(ArrDelay, na.rm = TRUE), keyby = Month])

# with dplyr
system.time(data2006 %>% 
              group_by(Month) %>% 
              summarise(mean(ArrDelay, na.rm = TRUE)))
```


Notice that `dplyr` functions run on data.tables (data2006 was imported as a data.table) as well as on tibbles and data frames as previously discussed.

The data.table syntax quickly gets more and more complicated. Suppose you want to apply two functions (for instance mean and standard deviation) to one variable:

```{r}
# with data.table
system.time(
  data2006[, list(mean(ArrDelay, na.rm = TRUE), sd(ArrDelay, na.rm=TRUE)), keyby = Month]
  )

# with dplyr
system.time( 
  data2006 %>% 
    group_by(Month) %>% 
    summarise_each(funs(mean(., na.rm = TRUE), sd(., na.rm = TRUE)), ArrDelay)
  )
```

and now two functions on two variables:

```{r}
# with data.table
system.time(
  data2006[, list(mean(ArrDelay, na.rm = TRUE), sd(ArrDelay, na.rm=TRUE),
                  mean(Distance, na.rm = TRUE), sd(Distance, na.rm=TRUE)), keyby = Month]
  )

# with dplyr
system.time( 
data2006 %>% 
    group_by(Month) %>% 
    summarise_at(vars(ArrDelay, Distance), funs(mean(., na.rm = TRUE), sd(., na.rm = TRUE)))
  )
```

 
`data.table` is thus faster than `dplyr`, but its syntax is much more complicated.

