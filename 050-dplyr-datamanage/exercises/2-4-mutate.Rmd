---
title:
author:
date:
output:
  html_document:
    self_contained: no
---

```{r setup, echo=FALSE, message=FALSE, results='hide'}
require(tidyverse) 
require(knitr) 
options(width=80)
opts_chunk$set(list(dev = 'png', fig.cap='', fig.show='hold', dpi=100, fig.width=7, fig.height=7, fig.pos='H!'))#, fig.path="figures/lm-"))
opts_knit$set(root.dir="./data")
show_solution <- if (exists("show_solution_mk")){
  show_solution_mk
} else {
  FALSE
}


# ATTENZIONE: leggere nota dentro show-solution.R
```



## `mutate()` and its friends
Note: all the exercises of this section are based on the `flights` dataset.  
Times are in minutes and distances are in miles.


```{r}
require(tidyverse)
require(nycflights13)
```


### Exercise 1
Add the following new variables to the `flights` dataset:

* the gained time in minutes, defined as the difference between delay at departure and delay at arrival;
* the speed in miles per hour (`distance` / `air_time` * 60).

Show only the following variables: delay at departure, delay at arrival, distance, air time and the two new variables (gained time and speed).

```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% mutate(gained_time = arr_delay - dep_delay, speed = distance/air_time*60)
```



### Exercise 2
Redo the previous calculations keeping only the new variables.

```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% 
  transmute(gained_time = arr_delay - dep_delay, speed = distance/air_time*60) 
```



### Exercise 3
After sorting flights in chronological order, for each flight calculate the difference between its delay at arrival and the delay at arrival of the immediately previous flight. Have R to show only the delay variables (delay at departure, delay at arrival and the new variable).


```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% 
  arrange(year, month, day) %>%
  mutate(lead_arr_delay = lead(arr_delay), delta_delay = lead_arr_delay - arr_delay) %>%
  select(dep_delay, arr_delay, delta_delay)
```



### Exercise 4
For each flight calculate the 'min ranking' in terms of delay at arrival.

```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% 
  mutate(min_rank_arr_delay = min_rank(arr_delay)) 
```



### Exercise 5
For each flight calculate the 'first ranking' in terms of delay at arrival.

```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% 
  mutate(first_rank_arr_delay = row_number(arr_delay)) 
```




### Exercise 6
Create a variable which indicates if a flight took off on time, i.e. departure delay is more than -4 and less than 4 minutes late.

```{r, echo = show_solution, eval = show_solution, cache=FALSE}
flights %>% 
  filter (arr_delay > -4 & arr_delay <4) %>%
  mutate(dep_on_time = 1) 
```

