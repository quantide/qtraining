---
title: "Creare un Line Plot"
output: html_document
---

```{r options, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = 'H', fig.width = 4, fig.height = 3)
options(width = 108)
```

<!--
# Creating a Line Plot
-->

```{r first, include=TRUE, purl=TRUE, message=FALSE}
require(dplyr)
require(ggplot2)
```

I line plot sono utilizzati per mostrare come una variabile continua, rappresentata sull'asse delle y, cambia in relazione ad un' altra variabile continua, rappresentata sull'asse delle x. E' un tipo di grafico simile allo scatter plot, ad eccezione del fatto che i punti sull'asse delle x sono ordinati e connessi da un segmento. I punti possono anche mancare.

<!--
Line plots are used to display how one continuous variable, on the y-axis, changes in relation to another continuous variable, on the x-axis. It is similar to a scatter plot, except that points are ordered in the x-axis and connected by a segment. Points can also be missing. 
-->

```{r lineplots, message=FALSE, echo=FALSE, purl=FALSE}
ds = data.frame(x=0:6, y=c(0,3,7,12,20,30,45.6))

ggp <- ggplot(data=ds, aes(x=x, y=y)) + 
  geom_line(colour="#2B4C6F") +  
  xlab("Explanatory variable\n(x)") + ylab("Response variable\n(y)") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank())

gridExtra::grid.arrange(ggp+geom_point(colour="#2B4C6F"), ggp, ncol=2)
```

Questo capitolo spiega come costruire un line plot e introduce altri concetti base della gramamtica di `ggplot2`, come: l'estetica `group` e le scale manuali.

<!--
This chapter presents how to build line plots and introduces other basic concepts of `ggplot2` graphics: `group` aesthetic and manual scales.
-->

## Il mio primo line plot

Il dataset `ChickWeight` contiene il peso di 50 polli mkisurato nel tempo. Supponiamo di essere interessati alla crescita del primo pollo.

<!--
## The first line plot

`ChickWeight` data contains the body weight of 50 chicks over time. Suppose you are interested to the growth of the first chick.
-->

```{r linegraph_first, message=FALSE}
ggplot(data=(ChickWeight %>% filter(Chick==1)), mapping=aes(x=Time, y=weight)) + 
  geom_line()
```

L'aspetto della linea può essere cambiato impostando gli argomenti della funzione `geom_line()`. Ad esempio, possiamo decidere di impostare il colore blu scuro e cambiarne le dimensioni in questo modo:

<!--
You can change the appearance of the line setting `geom_line()` aestethic arguments. For example, you can set dark blue color for line and change the size in this way:
-->

```{r linegraph_set, message=FALSE}
ggplot(data=(ChickWeight %>% filter(Chick==1)), mapping=aes(x=Time, y=weight)) +
  geom_line(colour="darkblue", size = 2) 
```

Possiamo anch scegliere lo stile della linea, impostando l'argomento `linetype`. Se utilizzate la grafica base di R, `linetype` ha lo stesso significato di `lty`.  

<!--
You can also choose the style of the line setting `linetype` argument. If you are experienced with R basic graphic, `linetype` has the same meaning that `lty`.
-->

```{r linegraph_linetype, message=FALSE}
ggplot(data=(ChickWeight %>% filter(Chick==1)), mapping=aes(x=Time, y=weight)) +
  geom_line(colour="darkblue", size = 2, linetype=2)
```

`linetype` può essere impostato come numero (0-6) o stringa (come `"solid"` o `"dashed"`). I tipi di linea disponibili sono:

<!--
The `linetype` can be a number (0-6) or a description (like `"solid"` or `"dashed"`). Available line types are:
-->

```{r plot_linetypes, echo=FALSE, fig=TRUE, purl=FALSE}
par(mar=rep(0,4))
# Make an empty chart
plot(1, 1, xlim = c(0.5, 5.5), ylim=c(0.5, 7.5), type = "n", axes = FALSE, ann = FALSE, frame.plot = TRUE, mar=0)
# Default values
x0 = 0.5 # Text x coordinate
xs = 1.8 # Line start point
xe = 5.2 # Line end point
cex0 = 1 # Default text size (cex)
pos0 = 4 # Default text position (pos): right
lwd0 = 2 # Default line width (lwd)
# Line 0
text(x = x0, y = 7, labels = '0. "blank"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(7, 7), lty = 0, lwd = lwd0)
# Line 1
text(x = x0, y = 6, labels = '1. "solid"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(6, 6), lty = 1, lwd = lwd0)
# Line 2
text(x = x0, y = 5, labels = '2. "dashed"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(5, 5), lty = 2, lwd = lwd0)
# Line 3
text(x = x0, y = 4, labels = '3. "dotted"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(4, 4), lty = 3, lwd = lwd0)
# Line 4
text(x = x0, y = 3, labels = '4. "dotdash"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(3, 3), lty = 4, lwd = lwd0)
# Line 5
text(x = x0, y = 2, labels = '5. "longdash"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(2, 2), lty = 5, lwd = lwd0)
# Line 6
text(x = x0, y = 1, labels = '6. "twodash"', cex = cex0, pos = pos0)
lines(x = c(xs, xe), y = c(1, 1), lty = 6, lwd = lwd0)
```

Gli attributi estetici per `geom_line()` sono `alpha`, `colour`, `size` e `linetype`. I primi tre argomenti hanno lo stesso (intuitivo) significato già visto per `geom_point()`.

Possiamo anche aggiungere i punti al grafico, utilizzando la funzione `geom_point()`: 
<!--
Available aestethics arguments for `geom_line()` are `alpha`, `colour`, `size` and `linetype`. The first three arguments have the same (intuitive) meaning already seen for `geom_point()`.

You can also add points to the plot with `geom_point()`:
-->

```{r linegraph_geompoint, message=FALSE}
ggplot(data=(ChickWeight %>% filter(Chick==1)), mapping=aes(x=Time, y=weight)) + 
  geom_line() + 
  geom_point()
```

## Mappare variabile ai line plots

Supponiamo di essere interessati alla crescita media dei polli in accordo con i differenti tipi di dieta. Per prima cosa dobbaimo fare un summary dei dati.

<!--
## Mapping variables to line plots

If you are interested in the average growth of chicks for the different diets, you must first summarize data.
-->

```{r linegraph_ChickWeightMean, message=FALSE}
ChickWeightMean <- ChickWeight %>% 
  group_by(Time, Diet) %>% 
  summarize(weight=mean(weight))
ChickWeightMean
```

Se si disegna il grafico sopra con i nuovi dati, otterremo questo grafico.

<!--
If you draw the same plot as above with new data, you will obtain a figure like this one.
-->
```{r linegraph__sawtooth, message=FALSE}
ggplot(data=ChickWeightMean, mapping=aes(x=Time, y=weight)) +
  geom_line() + 
  geom_point()
```

Vediamo una linea frastagliata con più punti per ogni `x`, che abbiamo detto a `ggplot` di connettere. Un garfico come questo ci suggerisce che c'è qualcosa di sbagliato. Per avere un unico punto per ogni `x` si puà fare un summary dei dati o si possono diseganre più linee, in accordo con una terza variabile, aggiungendo una nuova estetica. 

<!--
A jagged line appears when there are multiple data at each `x` and you tell `ggplot` to connect them. A plot like this one should sounds as a warning that something is wrong. In order to have a single point for each `x` you can summarize your data, or you can draw several lines, accordingly to a third variable, just adding a new aesthetic.
-->

```{r linegraph_aes, message=FALSE}
ggplot(data=ChickWeightMean, mapping=aes(x=Time, y=weight, colour=Diet)) +
  geom_line() + 
  geom_point()
```

In certi casi, la variabile mappata sull'asse delle `x` è categoriale. Questo è il caso in cui si hanno valori numerici che sono concepiti come categorici. Il dataset `ToothGrowth` può fornire un ottimo esempio. Esso contiene informazioni in merito all'effetto della vitamina C sulla crescita dei denti nei mailai di Guinea. Il comando seguente fa un summary dei dati per ottenere la lunghezza media dei denti per fornitore e dose di vatamina C:
<!--
Sometimes, the `x` variable can be a categorical variable. This is the case when you have numerical values that are conceived as categorical ones. The `ToothGrowth` data set can be a good case in point. It provides the effect of Vitamin C on Tooth Growth in Guinea Pigs. Data can be summarized as follow to achieve the mean tooth length by supplier and dose:
-->
```{r linegraph_tg, message=FALSE}
tg <- ToothGrowth %>% 
  group_by(supp, dose) %>% 
  summarize(length=mean(len))
tg
```

Possiamo rappresentare nel grafico una linea per ogni valore di `supp`: 
<!--
You can plot a line for each `supp` value:
-->
```{r linegraph_numericx, message=FALSE}
ggplot(data=tg, mapping=aes(x=dose, y=length, colour=supp)) +
  geom_line() + 
  geom_point()
```

Il grafico sembra buono, ma lo spazio tra i livelli della variabile `dose` non è mlto bello da vedere. Sarebbe meglio se lo spazio tra 0.5-1.0 e 1.0-2.0 fosse lo stesso. Per raggiungere questo obiettivo, è necessario trasformare la variabile `dose` in un fattore.

<!--
The plot is good but since `dose` level are fixed the space between 0.5-1.0 and 1.0-2.0 should be the same. You can fix this issue, transforming `dose` into a factor.
-->
```{r linegraph_factorx, message=TRUE}
ggplot(data=tg, mapping=aes(x=factor(dose), y=length, colour=supp)) +
  geom_line() + 
  geom_point()
```

Come possiamo notare, non è stata tracciata alcune linea sul grafico ed è stato restituito un messaggio di warning. Molto probabilmente si tratta di uno dei problemi più frequenti con `geom_line()`. Questo succede perchè `geom_line()` tenta di connettere i punti che appartengono allo stesso gruppo e ogni combinazione dei livelli delle variabili fattoriali appartiene ad un gruppo diverso. 
Per risolvere questo tipo di problema, è necessario specificare manualente il raggruppamento, mappando l'estetica `group`:

<!--
As you can see from the plot no lines are drawn and a warning message is returned. Probably, this is one of the most frequently problems with `geom_line()`. This appens because `geom_line()` tries to connect data points that belong to same group and the combinations of different levels of factor variables belong to different groups. 

To resolve this problem, you have to manually specify the grouping, setting `group` argument:
-->
```{r linegraph_group, message=FALSE}
ggplot(data=tg, mapping=aes(x=factor(dose), y=length, colour=supp, group=supp)) +
  geom_line() + 
  geom_point()
```

`group=supp` in `aes()` indica a ggplot come raggruppare i dati nel momento in cui traccia le linee.
Se invece si desidera ottenere un'unica linea che connetta tutti i punti, bisogna specificare `group=1`.
<!--
`group=supp` in `aes()` tells ggplot how to group data when it draws the lines. 

Otherwise, if you want a single line than connects all data points, you have to specify `group=1`.
-->
```{r linegraph_group1, message=FALSE}
# Consider only "OJ" supplier
ggplot(data=(tg%>%filter(supp=="OJ")), mapping=aes(x=factor(dose), y=length, group=1)) +
  geom_line() + 
  geom_point()
```

Quando i punti si sovrappongono, si possono distanziare, in inglese _dodge_. Si tratta di un piccolo aggiunstamento dei punti a destra e sinistra, che però deve essere applicato sia a linee che a punti, per evitare di visualizzare un disallineamento.

<!--
When points overlap, you can _dodge_ them. Dodging adjusts points left and right and must be applied to both lines and points, to avoid misalignment.
-->
```{r linegraph_dodge, message=FALSE}
ggplot(data=tg, mapping=aes(x=factor(dose), y=length, colour=supp, group=supp)) +
  geom_line(position=position_dodge(0.15)) + 
  geom_point(position=position_dodge(0.15))
```

L'argomento `position` sia di `geom_line()` che di `geom_point()` è stato impostato a `position_dodge()`, una funzione di `ggplot2` che regola la posizione in modo da evitare sovrapposizioni. 0.15 è l'ampiezza (`width`) specificata. 

<!--
`position` argument of both `geom_line()` and `geom_point()` is set equal to `position_dodge()`. `position_dodge()` is a `ggplot2` function that adjust position by dodging overlaps to the side. 0.15 is the `width` specified. 
-->

## Cambiare l'aspetto delle estetiche mappate

Quando vengono alimentati i polli, viene utilizzata il mangime di tipo "A" per la dieta numero 1, il mangime "B" per la dieta numero 2, il "C" per la 3 e il "D" per la 4. 

<!-- 
## Changing the Appearance of Mapped Aesthetics

When you feed your chicks, you use the "A" fodder for diet 1, the "B" fodder for diet 2, the "C" for diet 3 and the "D" for diet 4. 
-->
```{r linegraph_labels, message=FALSE}
ChickWeightMean <- ChickWeightMean %>%
  mutate(Diet = factor(Diet, levels=1:4, labels=c("A","B","C","D")))
```

Il mangime di tipo "A" viene venduto in sacchi rossi e gli allevatori identificano questo prodotto con il colore rosso. Con la stessa logica, il mangime di tipo "B" vine associato con il colore blu, il "C" con il verde e il "D" con l'arancione. Quindi per migliorare la leggibilità del grafico, tracceremo le linee per ogni tipo di dieta con il colore che identifica il tipo di mangime associato.

Non è possibile impostare il colore dentro le funzioni `ggplot()` o `geom_line()` utilizzando l'argomento `colour`; questo è possibile solamente se una variabile non è mappata sull'estetica `colour`. E' però possibile imposatre manualmente i colori con la funzione `scale_colour_manual()`.

<!--
"A" fodder is sold in red bags and farmers immediately identify this product with the red colour. In the same way, B is associated with the blue, C with the green and D with the orange. To improve the readability of the plot, lines for each diet should be of the colour that identify the fodder maker.

You cannot set the colour inside `ggplot()` or `geom_line()` using the `colour` argument, because this is admitted only when a variable is not _mapped_ to the `colour` aesthetic. You can set manually the colour with the function `scale_colour_manual()`.
-->
```{r linegraph_setcolourmanual, message=FALSE}
ggplot(data=ChickWeightMean, mapping=aes(x=Time, y=weight, colour=Diet)) +
  geom_line() + 
  geom_point() + 
  scale_color_manual(values=c("red", "blue", "green", "orange"))
```

Il vettore di stringhe contenti i nuovi colori da attribuire alle linee devono essere ordinati nello stesso ordine con cui appaioni nella legenda. Per essere sicuri della corrispondenza tra colore e dati, è anche possibile passare a `values` un vettore nominato.

Questo e tanto altro, sempre inerente alla personalizzazione delle estetiche mappate sarà approfondito nel capitolo "Personalizzazione delle estetiche mappate".

<!--
Colours in the `values` string vector must appear in the same order as they appear in the legend. You can pass a named vector to be sure of the correspondence between colour and data.

Mapped Aesthetics customization will be deepen in "Mapped Aesthetics Customization" chapter.
-->

## Aggiungere linee orizzontali e verticali al grafico

I grafici a linee spesso includono anche linee verticali e orizzontali.  
Supponiamo di voler analizzare la crescita media dei nostri polli per ogni tipo di dieta. 

<!--
## Adding horizontal and vertical lines

Line plots often contains horizontal or vertical lines.

It may be interesting to analyse the average daily growth for each diet type.
-->
```{r linegraph_ChickWeightGrowthMean, message=FALSE}
ChickWeightGrowth <- ChickWeight %>% 
  group_by(Chick) %>%
  mutate(growth=c(0,diff(weight))) %>% 
  filter(growth != 0)
  
ChickWeightGrowthMean <- ChickWeightGrowth %>% 
  group_by(Time, Diet) %>%
  summarize(growth=mean(growth)) 

ggp <- ggplot(data=ChickWeightGrowthMean, mapping=aes(x=Time, y=growth, colour=Diet)) +
  geom_line(mapping=aes(linetype=Diet)) + 
  geom_point(mapping=aes(shape=Diet))

ggp
```

A questo punto, aggiungiamo la linea che identifica la crescita media al grafico. 
<!--
At this point you may want to add the average growth to the plot.
-->

```{r linegraph_hline, message=FALSE}
growth_avg <- ChickWeightGrowth %>%
  magrittr::use_series(growth) %>% 
  mean

ggp1 <- ggp + 
  geom_hline(yintercept = growth_avg, colour="grey20")

ggp1
```

I dati si riferiscono ad un periodo di tre settimane. Sarebbe, infine, interessante evidenziare ogni settimana aggiungendo una linea verticale in corrispondenza dei giorni 7, 14 e 21.

<!--
Data refers to a three-weeks period. It may be interesting to highlight each week adding a vertical line at days 7, 14 and 21.
-->
```{r linegraph_vline, message=FALSE}
ggp1 + 
  geom_vline(xintercept = c(7,14,21), colour="grey40", linetype=3)
```

