---
title: "Creare uno Scatter Plot"
output: html_document
---

```{r options, include=FALSE, purl=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.pos = 'H', fig.width = 4, fig.height = 3)
options(width = 108)
```

<!--
# Creating a Scatter Plot
-->

```{r first, include=TRUE, purl=TRUE, message=FALSE}
require(dplyr)
require(ggplot2)
require(qdata)
data(bands)
```

Gli scatterplot sono utilizzati per mostrare la relazione tra due variabili continue. Ogni asse rappresenta una variabile, mentre ogni punto rappresenta un'osservazione. Solitamente, questo è il tipo di grafico che si utilizza per dare un primo sguardo ai dati. 

<!--
Scatter plots are used to display the relationship between two continuous variables. Axes represent a variable each, while each point represents an observation. This plot is often the first way to describe data when you look at it. 
-->

```{r scatterplots, message=FALSE, echo=FALSE, purl=FALSE}
set.seed(123456)
ds <- data.frame(matrix(rnorm(40*4, 4), ncol=4))

ggplot(data=ds) + geom_point(aes(x=X1, y=X2, size=X3*1), colour="#2B4C6F", show.legend = FALSE) +
  xlab("Explanatory variable\n(x)") + ylab("Response variable\n(y)") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank())
```

Questo capitolo spiega come costruire gli scatter plot e introduce alcuni cocnetti base della grammatica di `ggplot2`: gli aesthetic mappings e i layers.

<!--
This chapter presents how to build scatter plots and introduces some basic concept of `ggplot2` grammar: aesthetic mappings and layers.
-->

## Il mio primo scatter plot

Supponiamo di essere interessati a rappresentare la relazione tra umidità e viscosità nel dataset `bands`.

<!--
## The first scatter plot

Suppose you are interested in the relationship between the humidity and the viscosity in the `bands` dataset. 

-->

```{r scatterplot_first, message=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point()
```

La sintassi da utilizzare è abbastanza semplice. La funzione `ggplot()` inizializza il grafico con i seguenti parametri:

* _data_ si riferisce al dataframe da utilizzare per il grafico, in questo caso è il data frame `bands`  
* _mapping_ si riferisce alla lista di aesthetic mappings (visual properties) da usare per il grafico, passate come argometi della funzione `aes()`. In questo caso i dati vengono _mappati_ alle _estetiche_ del grafico come segue: l'asse delle _x_ mostra la variabile `humidity` mentre l'asse delle _y_ mostra la variabile `viscosity`. 

Note:

* i nomi delle variabili devono essere scritti senza virgolette
* la funzione da utilizzare si chiama `ggplot()`, mentre il pacchetto si chiama `ggplot2`

<!--
The syntax is quite simple. The function `ggplot()` initializes the plot with the following parameters: 

* _data_ refers to the dataframe to use for the plot, in this case is the `bands` data frame 
* _mapping_ refers to the  list of aesthetic mappings (visual properties) to use for plot, passed as arguments of the `aes()` function. In this case you _map_ the data to _aesthetics_  of plot like follow: the _x_-axis displays the `humidity` variable and the _y_-axis displays the `viscosity` variable. 

Notes: 

* the variable names must be unquoted 
* the function is named `ggplot()` while the package is named `ggplot2`
-->



La funzione `ggplot()` non ritorna nulla. E' necessario aggiungere a  `ggplot()` il _geom_ che si vuole aggiungere. Uno scatterplot è fatto di punti, quindi utilizzeremo la funzione `geom_point()`, senza alcun argomento. Il significato dei termini tecnici sarà chiarito negli esempi seguenti.   
La funzione restituisce un messaggio di warning: in sei osservazioni tra `humidity` e `viscosity` ci sono valori mancanti e i punti non possono essere rappresentati. Nei prossimi esempi, warning di questo tipo non saranno mostrati.  

Alternativamente, il grafico può essere inizializzato per mezzo della funzione `ggplot()` senza alcun argomento e i suoi argomenti possono essere definiti all'interno di `geom_point()`. 

<!--

The `ggplot()` function does not return anything. You have to add to `ggplot()`, which geometric object (_geom_) you want to add. A scatter plot is made by points, and so you will use the `geom_point()` function, without any argument. 

The meaning of technical terms will be cleared in the following examples.

The function returns a warning message: in six observations at least one between `humidity` and `viscosity` has missing values and points cannot be drawn. In the following examples, the warning message will not be shown.

Alternatively, the plot can be initialized with `ggplot()` without any argument and the same arguments have to be passed to `geom_point()`.
-->

```{r scatterplot_geompoint, message=FALSE, warning=FALSE}
ggplot() + 
  geom_point(data=bands, mapping=aes(x=humidity, y=viscosity))
```

Per capire la differenza tra i due esempi precedenti, possiamo aggiungere un altro `geom` al grafico. Dal garfico precedente sembra esserci una (debole) correlazione positiva tra le variabili, perciò possimao aggiungere una retta di regressione. La funzione `geom_smooth()` con argomento `method="lm"` aggiunge una retta di regressione basata sul modello lineare.

<!--
To understand the difference between the two examples above, you can add a new `geom` to the plot. From the previous plot it appears a (weak) positive correlation between the variables. A regression line can be added to the plot. The `geom_smooth()` with `method="lm"` adds a regression line based on the linear model.
-->

```{r scatterplot_geomsmooth, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point() + 
  geom_smooth(method="lm")
```

Il grafico ora mostra una retta di regressione con il suo intervallo di confidenza. Proviamo ad aggiungere la retta di regressione partendo dalla funzione `ggplot()` senza argomenti.

<!--
The plot now displays a regression line with its confidence interval.  

You can try to add a smoother to the plot, but starting from the code with `ggplot()` without arguments.
-->

```{r scatterplot_noinherit, message=FALSE, warning=FALSE}
ggplot() + 
  geom_point(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_smooth(method="lm")
```

Nel grafico non ci sono linee. Perchè? Il ragione è semplice: `geom_smooth()` non sa che dati e che variabili devono essere utilizzate per il modello lineare. Possiamo risolvere così il problema:

<!--
There is no line. Why? The reason is quite simple: `geom_smooth()` do not know which data and which variable should be used for the linear model. You can solve the issue like follow.
-->

```{r scatterplot_settinggeoms, message=FALSE, warning=FALSE}
ggplot() + 
  geom_point(data=bands, mapping=aes(x=humidity, y=viscosity)) +
  geom_smooth(data=bands, mapping=aes(x=humidity, y=viscosity), method="lm")
```

Riassumendo, i dati e le estetiche specificati in `ggplot()` vengono utilizzati per default da tutti i layers. Se invece il layer ha definiti al suo interno dati e/o estetiche, quel layer ignora e sovrascrive i valori di default.

<!--
To sum up, data and aesthetics specified in `ggplot()` are used by default by all layers. Layers are like tracing papers, you can overlay them. Each layer contains a geometry. If a layer has its own data and/or aesthetics, that layer will ignore the default values.
-->

## Assegnare un oggetto `ggplot` ad una variabile

Da un punto di vista formale, un oggetto ggplot è un oggetto di R come tutti gli altri, perciò può essere asseganto ad una variabile. 

<!--
## Assigning `ggplot`s to a variable

From a formal point of view, a ggplot is an R object like anything else; so you can assign it to a variable.
-->

```{r scatterplot_assignment1, message=FALSE, warning=FALSE}
gp1 <- ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point() 
```

Quindi possiamo richiamare l'oggetto `gp1`.

<!--
And now you can recall the plot named `gp1`.
-->

```{r scatterplot_assignment2, message=FALSE, warning=FALSE}
gp1
```

_Nota_: è possibile stampare il grafico richiamandolo, infatti eseguire `gp1` fa lo stesso lavoro del comando `print(gp1)`.  
<!--
_Note_: you can print the plot by recalling it; indeed the run of `gp1` does the same work of `print(gp1)` command.

Once you assigned the scatter plot to `gp1`, you can add to this plot a smoother by doing:
-->

```{r scatterplot_assignment3, message=FALSE, warning=FALSE}
gp2 <- gp1 + 
  geom_smooth(method="lm")
gp2
```

## Cambiare la forma e la dimensione dei punti

A questo punto, potremmo essere interessati a cambiare l'aspetto dei punti, come la loro forma o la loro dimensione. Per fare ciò basta impostare i parametri `shape` o `size` della funzione `geom_point()`. 

<!--
## Changing the shape and size of points

At this point, you probably are interested to change the aspect of points like shape or size: it suffices to set the `shape` or the `size` as a parameter of `geom_point()`.
-->

```{r scatterplot_shape, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(shape=2)
```

Le seguenti forme sono disponibili nella grafica di R. Le forme dalla 0 alla 14 hanno solamente il contorno, quelle dalla 15 alla 20 sono solide mentre quelle dalla 21 alla 25 hanno sia il contorno che il riempimento. La forma utilizzata per default da `ggplot2` è al numero 16-

<!--
The following shapes are available in R graphics. Point shapes from 0 to 14 have just an outline, shapes from 15 to 20 are solid and shapes from 21 to 25 have both an outline and a fill. Default shape for `ggplot2` graphics is 16.
-->
```{r plot_shape, echo=FALSE, fig=TRUE, purl=FALSE}
 par(mar=rep(0,4))
 # Make an empty chart
 plot(1, 1, xlim = c(1, 5.5), ylim=c(0.5, 9.5), type = "n", axes = FALSE, ann = FALSE, frame.plot = TRUE, mar=0)
 # Plot symbols 0-4 with increasing size
 points(1:5, rep(9, 5), cex = 2, pch = 0:4, col="red", bg="green")
 text((1:5) + 0.4, rep(9, 5), cex = 1, (0:4))
 # Plot symbols 5-9 with labels
 points(1:5, rep(7, 5), cex = 2, pch = (5:9), col="red", bg="green")
 text((1:5) + 0.4, rep(7, 5), cex = 1, (5:9))
 # Plot symbols 10-14 with labels
 points(1:5, rep(5, 5), cex = 2, pch = (10:14), col="red", bg="green")
 text((1:5) + 0.4, rep(5, 5), cex = 1, (10:14))
 # Plot symbols 15-19 with labels
 points(1:6 * 0.8 + 0.2, rep(3, 6), cex = 2, pch = (15:20), col="red", bg="green")
 text((1:6) * 0.8 + 0.6, rep(3, 6), cex = 1, (15:20))
 # Plot symbols 20-25 with labels
 points((1:5), rep(1, 5), cex = 2, pch = (21:25), col="red", bg="green")
 text((1:5) + 0.4, rep(1, 5), cex = 1, (21:25))
```

La forma che si vuole impostare può anche essere una singola stringa di tipo caratteriale. 
<!--
Shape can also be a (single) character string.
-->
```{r scatterplot_shape_char, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(shape="$", size=3)
```

Lo stesso vale per la dimensione (`size`).

<!--
The same way works for `size` too.
-->

```{r scatterplot_size, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(size=5)
```

```{r scatterplot_shape_size, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(shape=3, size=1)
```

## Cambaire il colore dei punti

Il colore può essere impostato nello stesso modo in cui vengono impostati la forma (`shape`) e la diemnsione (`size`). Il parametro può essere definito sia secondo lo spelling UK che US (`color`).  

<!--
## Changing the colour of points

Colour can be set in a similar way than `shape` and `size`: setting `colour` as a `geom_point()` parameters. Both UK and US spellings (`color`) can be used.
-->
```{r scatterplot_colour, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(colour="red")
```

Le forme dalla 21 alla 25 consentono l'utilizzo di due colori: `colour` è il parametro che imposta il colore della linea di contorno e `fill` quello del colore di riempimento.

<!--
Shapes from 21 to 25 allow two colours. In these cases, `colour` set the outline and `fill` set the internal colour.
-->

```{r scatterplot_fill, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) + 
  geom_point(shape=21, colour="red", fill="#2b439a")
```

In R, per definire il colore da utilizzare si può impostare stringa contenente il nome del colore, ce ne sono 657 di disponibili, basta digitare `colours()` per vederli. Altrimenti è possibile anche passare una stringa contenete il codice esadecimale (e.g. "#2b439a"), oppure si possono utilizzare le funzioni `rgb()`, `hsv()` o `hcl()` se si è familairi con questo tipo di modelli colore.  

Il dataset utilizzato per questi esempi ha 540 ossevazioni, ma guardando il grafico sembrano esserci meno punti. Questo succede perchè alcuni punti si sovrappongono. Una possibile soluzione al problema può essere la trasparenza. L'estetica `alpha` imposta il livello di trasparenza, che assume valori tra 0 (trasparente) e 1 (opaco) compresi.   
<!--
When you need to pass a colour to R, you can use a string with the colour name. There are 657 colour names in R; just type `colours()` to view them. Alternatively, you can pass a string with the hexadecimal code (e.g. "#2b439a") or you can use `rgb()`, `hsv()` or `hcl()`  if you are familiar with these colour models.

Data used in these examples has 540 observations but the plot seems have less points. This is because many points overlap. Transparencies are useful in this cases. The `alpha` aesthetic set the transparency level: legal `alpha` values are any numbers from 0 (transparent) to 1 (opaque). 
-->

```{r scatterplot_alpha, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) +
  geom_point(alpha=0.25)
```

Ad esempio, se `alpha=0.25` (e 0.25 è 1/4) un punto verrà rappresentato come solido quando quattro saranno sovrapposti.

Se utilizzate già la grafica base di R, `shape` sostituisce `pch`, `size` sostituisce `cex`, `colour` sostituisce `col` e `fill` sostituisce `bg`. La sintassi di R base può essere utilizzata ance con `ggplot2` ma si raccomanda fortemente di migrare verso la nuova e più intuitiva sintassi.


<!--
Since `alpha=0.25` (and 0.25 is 1/4) a point will be drawn as solid when four points overlap.

If you are familiar with base graphics in R, `shape` substitutes `pch`, `size` substitutes `cex`, `colour` substitutes `col` and `fill` substitutes `bg`. The base syntax can be used also in `ggplot2` but it is strongly suggested to migrate to the new and more intuitive syntax.
-->

## Mappare una terza variabile nello scatter plot

Gli scatter plot sono nati per visualizzare la relazione tra due variabili: una mappata sull'asse delle x e una sull'asse delle y. Spesso, però, è necessario rappresentare anche una terza variabile. In questi casi la terza variabile va mappata su altre estetiche come: size, shape or colour. 

Supponiamo di essere interessati alla relazione tra le variabili `humidity` e `viscosity` in accordo con la presenza o meno di `band_type`. `band_type` è una variabile discreta, quindi possiamo mapparla su `colour`.

<!--
## Mapping a third variable to scatter plots

Scatter plots were born to visualize the relationship between two variables: one mapped to the x-axis and one mapped to the y-axis. Sometimes, a third variable should be visualized. In these case, you can map a third variable to other aesthetics: size, shape or colour.

Suppose you're interested in the relationship between humidity and viscosity accordingly the presence or absence of `band_type`. `band_type` is a discrete variable so to perform this task, you can map it to `colour`. 
-->

```{r scatterplot_map_colour, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, colour=band_type)) +
  geom_point()
```

E' importante notare come la mappatura avvenga all'internod ella funzione `aes()`, mentre l'impostazione delle estetiche avvenga al di fuori di `aes()`.

Il grafico è lo stesso del procedente a differenza del colore dei punti che identifica la presenza o assenza di `band_type`. Inoltre, è stata automaticamente aggiunta una legenda al grafico.



<!--
Note that mapping occurs within `aes()`, while setting occurs outside of `aes()`.

The plot shows the same points that previous ones with different colours and a legend will be added.

Alternatively, you can map `band_type` to another aesthetic, like `shape`.
-->
```{r scatterplot_map_shape, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, shape=band_type)) +
  geom_point()
```

Dato che forme diverse sono più difficili da leggere quando il grafico ha molti punti, questa soluzione fornisce un'alternativa nel caso in cui si stampi in bianco e nero, senza colori. E' possibile migliorare il risultato ussando entrambe le estetiche insieme.

<!--
Since different shapes are more difficult to read when you have many points, this solution provide an alternative when you are printing in black and white, without colours. You can improve your result using both aesthetics together.
-->

```{r scatterplot_map_colour_shape, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, colour=band_type, shape=band_type)) +
  geom_point()
```

Non è consigliato mappare una variabile discreta sull'estetica `size`.

Se siete interessati ad una terza variabile continua, potete mapparla su `colour` o su `size`. Non ha senso, invece, mappare una variabile continua su `shape`. Consideriamo la variabile `ink_pct` come terza variabile:

<!--
Mapping a discrete variable to `size` aestethic is not advised.

If you're interested in a continuous variable as third variable you can `map` it to `colour` or to `size`. It makes no sense map a continuous value to `shape`. Let us consider `ink_pct` as third variable:
-->

```{r scatterplot_map_colour_continuous, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, colour=ink_pct)) +
  geom_point()
```

```{r scatterplot_map_size_continuous, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, size=ink_pct)) +
  geom_point()
```

E' comunque più difficile percepire piccole differenze nella dimensione e nel colore, quindi le variabili mappate su queste estetiche saranna interpretati con meno accuratezza rispetto a quelli mappati sulle coordinate spaziali (`x` e `y`). 

Il comando seguende produce uno scatterplot tra `humidity` e `viscosity` con `band_type` mappato a `colour`.
<!--
It is more difficult perceiving small differences in size and colour, so variable mapped to these aesthetic attributes will be interpreted with a much lower accuracy than those mapped to spatial coordinates (`x` and `y`).

The following code will produce a scatter plot of `humidity` versus `viscosity` with `band_type` mapped to `colour`. 
-->

```{r scatterplot_map_colour_smooth, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, colour=band_type)) +
  geom_point() + geom_smooth(method="lm")
```

Lo scatter plot ha due rette di regressione. E' il risultato che ci si aspettava, poichè `band_type` è mappato a `colour` in `ggplot()` e i suoi argomenti sono utilizzati non solo da `geom_point()` ma anche da `geom_smooth()`.

<!--
The scatter plot has two regression lines. This is the expected results, as `band_type` is mapped to `colour` in the `ggplot()` function and its arguments are used not only by `geom_point()` but also by `geom_smooth()`.

To produce a scatter plot with a single regression line the `colour` aesthetic must be mapped only to `geom_point()`.
-->

```{r scatterplot_map_colour_onesmooth, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) +
  geom_point(mapping=aes(colour=band_type)) + 
  geom_smooth(method="lm")
```

Infine, questo è il grafico se siete interessati a tre rette di regressione, una per tutti i valori e una per ogni livello di `band_type`.

<!--
Finally, this is the plot if you are interested to three regression line, one for all values and one for each level of `band_type`.
-->
```{r scatterplot_map_colour_threesmooth, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity)) +
  geom_point(mapping=aes(colour=band_type)) + 
  geom_smooth(mapping=aes(colour=band_type), method="lm") +
  geom_smooth(method="lm")
```

## Mappare quattro variabili nello scatter plot

Sebbere l'interpretazione possa essere difficile, più variabili possono essere mappate su diverse estetiche allo stesso tempo. Da un punto di vista teorico è possibile mappare tante variabili quante sono le estetiche, ma non si consiglia di mappare più di quattro variabili.

Questo è il risultato quando si è interessati su `ink_percentage` e `band_type` allo stesso tempo.

<!--
## Mapping four variables to scatter plots

Although the interpretation may be difficult, different variable can map to different aesthetics at the same time. From a theoretical point of view you can map as many variable as the number of aesthetics, but it is not suggested map more than four variable.

This is the result when you are interested to the ink percentage and band type, at the same time.
-->

```{r scatterplot_map_four_variables, message=FALSE, warning=FALSE}
ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, size=ink_pct, colour=band_type)) +
  geom_point()
```

Quando una variabile è mappata su `size` non si suggerisce di mapparne un'altra su `shape`. Questo perchè è difficile confrontare le dimensioni di diverse forme.

<!--
When a variable is mapped to `size` it is not suggested to map another variable to `shape`. This is because it is difficult to compare the sizes of different shapes.
-->
