---
title: "More on legend"
output: html_document
---

```{r, echo=FALSE, message=FALSE}
require(ggplot2)
require(qdata)
require(grid)
data(bands)
```

A legend is a guide which tells us how to map visual (aesthetic) properties back to original data values. 
`ggplot2` automatically generates the legend according to the aesthetics mapped.

\includegraphics[]{./images/legend.png}
Let us see some examples.

Considering the `bands` data. Supposing you are interested in the differences of ink percentage accordingly to the type of press, you can build four box plots to compare distributions.

```{r, warning=FALSE}
pl <- ggplot(data=bands, aes(x=press_type, y=ink_pct, fill=press_type)) + geom_boxplot()
pl
```

As you can see from the plot, the legend is automatically built showing `press_type` variable levels. In this case, `press_type` variable is mapped to `fill` aesthetic. When a variable is mapped to an aesthetic it is automatically set to a scale. The default scale in this case is `scale_fill_discrete()`. There are other scales for `fill`, such as `scale_fill_manual()`. If you use scales for other aesthetics, such as `colour` (for lines and points) or `shape` (for points), you must refer to the appropriate scale. 


<!--
scrivere come utilizza la legenda (theme, guides, scale)

`ggplot2` allows one to handle with the appearance of the legend by using two important elements of its grammar: 

* `scale`, which controls the mapping from data to aestethics attributes
* `guides()` fucntion, which controls guides for each scale 
* `themes`, which controls the non-data elements of the plot 

-->

In the following paragraphs we will see how to handle with the most common questions on legend customization.

## Removing the legend

Sometimes a legend is redundant, or it is supplied in another graph that will be displayed with the current one. In these cases, it can be useful to remove the legend from a graph.
In the previous example, the colors provide the same information that is on the x-axis, so the legend is unnecessary.

To remove the legend you have three possibilities that work in the same way:

* use `guides()` function and specify the scale that should have its legend removed
* set `guide` argument to `FALSE` in the scale
* use the theming system specifying `legend.position` to `"none"`

```{r, warning=FALSE}
pl + guides(fill=FALSE)
pl + scale_fill_discrete(guide=FALSE)
pl + theme(legend.position="none")
```

The third is the better option if you have more than one aesthetic mapping with a legend (color and shape, for example) because this will remove legends for all of them.

Notice that with the legend removed, the area used for graphing the data is larger.


## Changing the position of a legend

If you want to move the legend from its default place on the right side you have to use `theme` function. The legend can be put on the top, left, right, or bottom by using one of those strings as value of `legend.position` argument.

Suppose we want to place the position on top:

```{r, warning=FALSE}
pl + theme(legend.position="top")
```

The allowed values for the argument `legend.position` are : "left", "top", "right", "bottom".

Suppose you have multiple legends in plot. For example, let us consider the relationship between the humidity, the viscosity, the ink percentage and band type in the `bands` dataset. 

```{r, warning=FALSE}
p <- ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, size=ink_pct, colour=band_type)) +
  geom_point()
p
```

In this case, legend are represented in different lines.

```{r}
p + theme(legend.position="bottom")
```

If you want to set legend in the same line set `legend.box` argument as "horizontal":

```{r}
p +theme(legend.position="bottom", legend.box = "horizontal")
```


The legend can also be placed inside the graphing area by specifying a coordinate position. In this case, the argument `legend.position` has to be set as a numeric vector c(x,y), whose values should be between 0 and 1:

```{r, warning=FALSE}
pl + theme(legend.position=c(0.15,0.80))
```

The coordinate space starts at (0, 0) in the bottom left and goes to (1, 1) in the top right.

In the previous plot, the justification of the legend positon is centered. This means that the center of the legend (.5, .5) is placed at the coordinate, but it is often useful to specify a different point. You can use `legend.justification` argument to set which part of the legend box is set to the position at `legend.position`. Let us set set left-top justification:

```{r, warning=FALSE}
pl + theme(legend.position=c(0,1), legend.justification=c(0,1))
```

<!--
modificare questo esempio. si capisce a cosa serve legend.justification? 
-->

When placing the legend inside of the graphing area, it may be helpful to add an opaque border to set it apart by setting `legend.background` argument of `theme` function:

```{r, warning=FALSE}
pl + theme(legend.position=c(0,1), legend.justification=c(0,1)) +
theme(legend.background=element_rect(fill="white", colour="black"))
```

`element_rect()` function allows us to customize backgrounds and borders.

You can also remove the border around its elements so that it blends in:

```{r, warning=FALSE}
pl + theme(legend.position=c(0,1), legend.justification=c(0,1)) +
theme(legend.background=element_blank()) + # Remove overall border
theme(legend.key=element_blank()) # Remove border around each item
```

`legend.key` argument of theme function refers to the customization of the border around each item.

Legend background can be customized also if legend is out of the plotting area:

```{r, warning=FALSE}
pl + theme(legend.background = element_rect(fill="lightblue",
    size=0.5, linetype="solid", colour ="darkblue"),
  legend.key  = element_rect(fill="lightblue",
    size=0.5, linetype="solid", colour ="lightblue"))
```

## Change the order of items in a legend

To change the order of the items in a legend set the limits in the scale to the desired order:

```{r, warning=FALSE}
pl + scale_fill_discrete(limits=c("MOTTER94", "MOTTER70", "WOODHEADE70", "ALBERT70"))
```

Note that the order of the items on the x-axis did not change. To do that, you would have to set the limits of `scale_x_discrete()` or change the data to have a different factor level order. For more detail see "Change axis order" paragraph in "More on axis" chapter.

## Reversing the order of items in a legend

Add `guides(fill=guide_legend(reverse=TRUE))` to reverse the order of the legend (for other aesthetics, replace fill with the name of the aesthetic, such as colour or size):

```{r, warning=FALSE}
pl + guides(fill=guide_legend(reverse=TRUE))
```

<!--
decidere se lasciarlo un paragrafo o metterlo insieme a "Change the order of items in a legend"
-->

## Change the order for multiple guides

If you want to reverse the order of the legend, use `guides()` function:

```{r}
p + guides(color = guide_legend(order=2),
         size = guide_legend(order=1))
```


## Change a legend title

The title of a legend can be changed in two ways:

* using `labs()` function and set the value of `fill`, `colour`, `shape`, or whatever aesthetic is appropriate for the legend
* in the scale specification settimg `name` argument
* using `guides()` function

```{r, warning=FALSE}
pl + labs(fill="Pressure Type")
pl + scale_fill_discrete(name="Pressure Type")
pl + guides(fill=guide_legend(title="Pressure Type"))
```

The controlling of the legend title by using the `guides()` function is a little more verbose, but it can be useful when you’re already using it to control other properties.

If there are multiple variables mapped to aesthetics with a legend (those other than x and y), you can set the title of each individually.

Suppose you are interested in the relationship between the humidity, the viscosity, the ink percentage and band type in the `bands` dataset. 
```{r, warning=FALSE}
p <- ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, size=ink_pct, colour=band_type)) +
  geom_point()
p
```

Change the legends title:

```{r, warning=FALSE}
p + labs(colour="Band Type", size="Ink \n Percentage")
```

If you have one variable mapped to two separate aesthetics, the default is to have a single legend that combines both:

```{r, warning=FALSE}
p_1 <- ggplot(data=bands, mapping=aes(x=humidity, y=viscosity, shape=band_type, colour=band_type)) +
  geom_point()
p_1
```

To change the title, you need to set the name for both of them. If you change the name for just one, it will result in two separate legends:

```{r, warning=FALSE}
p_1 + labs(shape = "Band Type")
p_1 + labs(shape = "Band Type", colour = "Band Type")
```

## Changing the appearance of a legend title

The appearance of the legend title can be changed by:

```{r, warning=FALSE}
pl + theme(legend.title=element_text(face="italic", family="Times", colour="red", size=14))
```

<!--
non metto che si può cambiare anche con guides (più complicato)
-->

## Removing a legend title

You can remove legend title by using `scale` or `guides()` funtions:

```{r, warning=FALSE}
pl + guides(fill=guide_legend(title=NULL))
pl + scale_fill_discrete(guide = guide_legend(title=NULL))
```


## Change the labels text in a legend

You have to set the labels of a legend in the scale:

```{r, warning=FALSE}
pl + scale_fill_discrete(labels=c("Albert 70", "Motter 70", "Motter 94", "Woodhoe 70"))
```

Note that the labels on the x-axis did not change. To do that, you would have to set the labels of `scale_x_discrete()` (see chapter "More on axis", paragraph "Changing the Text of Tick Labels"), or change the data to have different factor level names.

If you are also changing the order of items in the legend, the labels are matched to the
items by position. In this example we’ll change the item order, and make sure to set the
labels in the same order (Figure 10-14):

```{r, warning=FALSE}
pl + scale_fill_discrete(limits=c("MOTTER70", "WOODHOE70", "ALBERT70", "MOTTER94"),
  labels=c("Motter 70", "Woodhoe 70", "Albert 70", "Motter 94"))
```

If you have one variable mapped to two separate aesthetics, the default is to have a single legend that combines both. If you want to change the legend labels, you must change them for both scales; otherwise you will end up with two separate legends:

```{r, warning=FALSE}
# Change the labels for one scale
p_1 + scale_shape_discrete(labels=c("Band", "No Band"))
# Change the labels for both scales
p_1 + scale_shape_discrete(labels=c("Band", "No Band")) +
    scale_colour_discrete(labels=c("Band", "No Band"))
```

<!--
inserire anche grafico originale?
-->

## Changing the appearance of a legend label

Use `theme(legend.text=element_text())` to change the appearance of labels in a legend:

```{r, warning=FALSE}
pl + theme(legend.text=element_text(face="italic", family="Times", colour="red",
size=14))
```

It’s also possible to specify the legend label appearance via guides() , although this method is a bit unwieldy.

```{r, warning=FALSE}
pl + guides(fill=guide_legend(label.theme=element_text(face="italic", family="Times", colour="red", size=14, angle =0)))
```


## Using labels with a multiple lines of text

If you want to use legend labels that have more than one line of text, set the labels in the scale, using "\n" to represent a newline. In this example, we’ll use `scale_fill_discrete()` to control the legend for the fill scale:

```{r, warning=FALSE}
pl + scale_fill_discrete(labels=c("Albert 70 \n type", "Motter 70 \n type", "Motter 94 \n type", "Woodhoe 70 \n type"))
```

As you can see in the previois plot, with the default settings the lines of text will run into each other when you use labels that have more than one line. To deal with this problem, you can increase the height of the legend keys and decrease the spacing between lines, using `theme()`. To do this, you will need to specify the height using the `unit()` function from the `grid` package:

```{r, warning=FALSE}
pl + scale_fill_discrete(labels=c("Albert 70 \n type", "Motter 70 \n type", "Motter 94 \n type", "Woodhoe 70 \n type")) +
theme(legend.text=element_text(lineheight=.8),
legend.key.height=unit(1, "cm"))
```



