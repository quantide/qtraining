---
title: "Negative Binomial Examples"
---

```{r setup, include=FALSE, purl=FALSE}
require(knitr)

opts_chunk$set(list(dev = 'png',fig.cap='',fig.show='hold',dpi=100,fig.width=7, fig.height=7,fig.pos='H!',fig.path="images/oth-"))
```

```{r, message=FALSE}
require(ggplot2)
require(MASS) 
require(qdata)
```

## Example: Quine data

### Data description

Data is of 146 children from a large town in rural New South Wales, Australia.  
Five variables were collected:

* `Days`: number of days absent from school in a year
* `Age`: age in 4 levels
* `Eth`: aboriginal or non-aboriginal
* `Lrn`: slow learner (SL) or average learner (AL)
* `Sex`: sex of subject

### Data loading
The main aim of analysis is to model the number of absences in a year with the other variables.
```{r}
data(quine)
head(quine)
str(quine)
summary(quine)
```

### Inference and models
We can start modeling the number of days of absence by using a classical GLM Poisson model:
```{r}
quine_pois <- glm(Days ~ (Sex+Age+Eth+Lrn)^4, data = quine, family=poisson)
summary(quine_pois)
```
For simplicity, we try to reduce we don't go in details on the final model structure, and we analyze the residual plot.
```{r, warning=FALSE}
op <- par(mfrow=c(2,2))
plot(quine_pois)
par(op)
```

Residuals are not satisfactory, since the variability of standardized residuals clearly increases as response increases (upper-left subgraph).

Then, we will try a negative binomial model with the `glm.nb()` function of the MASS package:
```{r}
quine_nb0 <- glm.nb(Days ~ Sex*Age*Eth*Lrn, data = quine)
```

The default link for Negative Binomial family is "`log`". Other available link functions are `link="sqrt"` or `link="identity"`.

Now, let us quickly reduce the model
```{r, message=FALSE}
dropterm(quine_nb0, test="Chisq")
quine_nb1 <- update(quine_nb0, . ~ . - Sex:Age:Eth:Lrn, data=quine)
dropterm(quine_nb1, test="Chisq")
quine_nb2 <- update(quine_nb1, . ~ . - Sex:Age:Eth, data=quine)
dropterm(quine_nb2, test="Chisq")
quine_nb3 <- update(quine_nb2, . ~ . - Sex:Age:Lrn, data=quine)
dropterm(quine_nb3, test="Chisq")
quine_nb4 <- update(quine_nb3, . ~ . - Age:Eth:Lrn, data=quine)
dropterm(quine_nb4, test="Chisq")
quine_nb5 <- update(quine_nb4, . ~ . - Age:Lrn, data=quine)
dropterm(quine_nb5, test="Chisq")
quine_nb <- update(quine_nb5, . ~ . - Age:Eth, data=quine)
dropterm(quine_nb, test="Chisq")
```

```{r}
summary(quine_nb)
c(quine_nb$theta, quine_nb$SE.theta)
```
Notice that the size `theta` ($\theta$) is also estimated. Theta is the $r$ parameter in our theoretical description (see last paragraph of relative chapter).

The comparison between full model (`quine_nb0`) and last model (`quine_nb`) returns:
```{r}
anova(quine_nb, quine_nb0, test="Chisq")
```
which is marginally significant.

If we want to compare this last model with an equivalent Poisson model (`quine_pois`) we obtain:
```{r}
quine_pois=glm(Days~Sex*(Age+Eth*Lrn),family = poisson(),data=quine)
summary(quine_pois)
pchisq(2*(logLik(quine_nb)-logLik(quine_pois)), df=1, lower.tail=F)
```
Anyway, this test is not really adequate, since theta=+Inf is on the boundary of parameter space,
and thus the LRT is not applicable.

We could reduce the model also with the `step()` function, as for LM and GLM models:
```{r}
quine_nb_step <- step(quine_nb0)
summary(quine_nb_step)
```
step() provides a different model in this case, with two 3-way interactions more

```{r}
anova(quine_nb_step, quine_nb)
```
3-way interactions added are significant with alpha=0.05 but not with alpha=0.01
They have also some missing cells: it is arguable whether keep `quine_nb_step` or `quine_nb`.

```{r}
op <- par(mfrow=c(2,2))
plot(quine_nb)
par(op)
```

Residuals now are surely much better than in Poisson model.

## Example: Negative Binomial vs Poisson

We can see what happens when we fit a negative binomial model when a Poisson model actually works.  
Let us create a fictitious dataset with Poisson dependent variable and a simple linear model that relates independent variable and dependent variable:
```{r}
set.seed(123)
x <- runif(n=300, min=10, max=40)
set.seed(123)
y <- sapply(x, function(xx) rpois(n=1, lambda=exp(.5+.05*xx)))
```

Let us plot the data:
```{r}
ggp <- ggplot(data = data.frame(x=x,y=y), mapping = aes(x=x,y=y)) +
  geom_point(colour="blue", alpha=0.5)
print(ggp)
```

And then we estimate the Poisson model:
```{r}
fit <- glm(y ~ x, family=poisson)
summary(fit)
pchisq(fit$deviance, fit$df.residual, lower.tail = FALSE)
```
And the Negative Binomial model:
```{r}
fit.nb <- glm.nb(y ~ x)
summary(fit.nb)
```

The estimate of theta is large and with a very large standard error. This may be an indication that the Negative Binomial model is an over-parameterized model to fit data, and Poisson model is better. 