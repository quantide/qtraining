---
title: "Poisson Examples"
---

```{r setup, include=FALSE, purl=FALSE}
require(knitr)

opts_chunk$set(list(dev = 'png',fig.cap='',fig.show='hold',dpi=100,fig.width=7, fig.height=7,fig.pos='H!',fig.path="images/glm-"))
```

```{r, message=FALSE}
require(surveillance)
require(ggplot2)
require(dplyr)
require(qdata)
```

## Example: Chromosomal abnormalities

### Data description

Numbers (`ca`) of chromosomal abnormalities observed for various amounts (`doseamt`) and intensities (`doserate`) of gamma radiation. 
The numbers of cells per measurement varied.

```{r,echo=FALSE}
rm(list=ls())
```

### Data loading
```{r}
data(dicentric)
head(dicentric)
str(dicentric)
```

Chromosomal abnormalities is a non-continuous count variable. In this case, of course, the
linear model is generally not adequate to describe data. A Poisson model is the typical GLM useful for this
purpose.  
The default link function for the Poisson model is the natural logarithm.  
Note: in some cases a linear model could even work well, but inference on parameters would not be
reliable.

### Data management
Let us create a `conc` variable containing the concentration of chromosomal abnormalities, calculated with respect to the number of cells analyzed.
```{r}
dicentric <- dicentric %>% mutate(conc=ca/cells)
```

### Descriptives

Plot of `ca/cells` vs `doseamt` by `doserate` (one plot)
```{r,tidy=FALSE,fig.cap="Plot of doseamt Vs. ca/cells by doserate"}
ggp <- ggplot(data = dicentric, mapping = aes(x = doseamt, y = conc, colour=factor(doserate))) +
  geom_point() + 
  geom_line() +
  scale_color_discrete(name="doserate") 
print(ggp)
```
Plot of `ca/cells` vs `doserate` by `doseamt` (one plot)
```{r,tidy=FALSE,fig.cap="Plot of doserate Vs. ca/cells by doseamt"}
ggp <- ggplot(data = dicentric, mapping = aes(x = doserate, y = conc, colour=factor(doseamt))) +
  geom_point() + 
  geom_line() +
  scale_color_discrete(name="doseamt")
print(ggp)
```
Plot of `ca/cells` vs `doseamt` by `doserate` (separate plots)
```{r,tidy=FALSE,fig.cap="Plot of doseamt Vs. ca/cells by doserate (separate plots)"}
ggp <- ggplot(data = dicentric, mapping = aes(x = doseamt, y = conc)) +
  geom_point(colour="blue") + 
  geom_line(colour="blue") +
  facet_wrap(facets = ~doserate,nrow = 1) +
  ggtitle( "doseamt vs ca/cells given doserate")
print(ggp)
```
Plot of `ca/cells` vs `doserate` by `doseamt` (separate plots)
```{r,tidy=FALSE,fig.cap="Plot of doserate Vs. ca/cells by doseamt (separate plots)"}
ggp <- ggplot(data = dicentric, mapping = aes(x = doserate, y = conc)) +
  geom_point(colour="blue") + 
  geom_line(colour="blue") +
  facet_wrap(facets = ~doseamt,nrow = 1) +
  ggtitle( "doserate vs ca/cells given doseamt")
print(ggp)
```
Plot of `ca/cells` vs logarithm of `doserate` by `doseamt` (separate plots)
```{r,tidy=FALSE,fig.cap="Plot of doserate logarithm Vs. ca/cells by doseamt (separate plots)"}
ggp <- ggplot(data = dicentric, mapping = aes(x = log(doserate), y = conc)) +
  geom_point(colour="blue") + 
  geom_line(colour="blue") +
  facet_wrap(facets = ~doseamt,nrow = 1) +
  ggtitle( "log(doserate) vs ca/cells given doseamt")
print(ggp)
```
Plot of `ca/cells` vs log(`doserate`) by `doseamt` (one plot)
```{r,tidy=FALSE,fig.cap="log(doserate) vs ca/cells by doseamt"}
ggp <- ggplot(data = dicentric, mapping = aes(x = log(doserate), y = conc, colour=factor(doseamt))) +
  geom_point() + 
  geom_line() +
  ggtitle( "log(doserate) vs ca/cells given doseamt")+
  scale_color_discrete(name="doseamt")
print(ggp)
```
The pictures show that a linear relation between `ca/cells` and `doserate` or log(`doserate`) seems to exist. Also, this relation seems to change by varying levels of `doseamt`. 

Next level plot tries to represent the relation in a three-dimensional-like fashion:
```{r,tidy=FALSE,fig.cap="Level plot of conc Vs. doseamt and doserate"}
ggp <- ggplot(data = dicentric, mapping = aes(x = factor(doseamt), y = factor(doserate))) +
  geom_tile(mapping = aes(fill=conc))
print(ggp)

```

### Inference and models

**A first simple model**  
Now let us estimate a Poisson model. The default link is the logarithm. This "forces" the estimated mean being greater than 0.
Even here (like in Binomial case) the dispersion parameter is known and equal to 1. 
If Poisson model with log link holds, then the number of chromosomal anomalies should be proportional to the number of cells analyzed, and then the `log(cells)` variable should be included in the model.

Model estimate:
```{r}
fm0 <- glm(ca ~ log(cells) + doserate * doseamt, family = poisson(), data = dicentric)
summary(fm0)
```

The interaction between `doserate` and `doseamt` is significant, while main effect of `doserate` is not.

Plot of diagnostic graphs
```{r,fig.cap="Residual plot of first model"}
op <- par(mfrow = c(2, 2))
plot(fm0)
par(op)
```
A couple of observations (25 and 27) seem outliers or leverages.

**Second model: adding an offset term**  
If the Poisson distributional assumption is true, then the number of cells analyzed can be thought as an offset: it simply multiplies the mean of `ca` in one cell by the number of cells analyzed.  
In other words, if the expected number of chromosomal abnormalities for a cell is $\mu$, and the distribution is a Poisson($\mu$) then the expected number of chromosomal abnormalities for $k$ cells is $k \mu$, and the distribution is a Poisson($k \mu$).  
In this case `cells`  is not an explicative variable whose parameter has to be estimated, but simply a multiplicative constant for the mean. This is accomplished by adding an `offset` term to model depending from `cell`, when calling `glm()`. Since the link function is the logarithm, `cell` must be included in model as a log-transformed offset.  
Also, to simplify the interpretation of resulting model, and to obtain a more powerful model, that better accomodate possible non linearities in variable, `doseamt` is treated as a factor.

Model estimate:
```{r}
fm1 <- glm(ca ~ offset(log(cells)) + factor(doseamt) + doserate:factor(doseamt) - 1,
          family = poisson(), data = dicentric)
summary(fm1)
```
Now there is no parameter referring to cells. Also, Akaike Information Criterion (AIC) is much less than the one of first model.

Plot of diagnostic graphs
```{r,fig.cap="Residual plot of second model"}
op <- par(mfrow = c(2, 2))
plot(fm1)
par(op)
```

**Considering the log of doserate**

In descriptive graphs, it appeared that the relation betwen `log(doserate)` and concentration is linear.  
So, we will try a different model, that uses `log(doserate)` as explicative variable instead of simpler `doserate`.

Model estimate
```{r,tidy=FALSE}
fm2 <- glm(ca ~ offset(log(cells)) + factor(doseamt) + 
            log(doserate):factor(doseamt) - 1, family = poisson(), data = dicentric)
summary(fm2)
```
Plot of diagnostic graphs
```{r,fig.cap="Residual plot of third model"}
op <- par(mfrow = c(2, 2))
plot(fm2)
par(op)
```
This model performs better than the previous ones, since the residual plots seem more regular (at least, with respect to the first model), and the AIC is less than in previous two models.

We can also plot residuals Vs. fit and normal probability plot of Anscombe residuals:
```{r}
ds <- data.frame(res = anscombe.residuals(fm2,phi=1), fit = predict(fm2,type="response"))

ggp <- ggplot(data = ds, mapping = aes(x= fit, y= res)) + 
  geom_point() +
  geom_smooth(method="loess", se=FALSE, span=50) + 
  geom_hline(yintercept = 0, colour="red")
print(ggp)

ggp <- ggplot(data = ds, mapping = aes(sample = res)) + 
  stat_qq() +
  geom_abline(mapping = aes(intercept=mean(res),slope=sd(res)), colour="lightblue", size=1.2)
print(ggp)
```

Next, a plot of prediction of mean number of chromosomal anomalies per cell is produced. Here the predictions. 
```{r}
preddata <- dicentric[, c("cells", "doseamt", "doserate")]
preddata$cells <- 1
dicentric$pred <- predict(fm2, newdata = preddata, type = "response")
```
A plot for `log(doserate)` as independent variable:
```{r,tidy=FALSE,fig.cap="Plot of predictions of model with doserate log scale"}
ggp <- ggplot(data = dicentric, mapping = aes(x = log(doserate), y = conc)) +
  geom_point(colour="blue") + 
  geom_line(colour="violet", mapping = aes(y=pred), size=1.2) +
  facet_wrap(facets = ~doseamt,nrow = 1) +
  ggtitle( "ca/cells  vs. log(dosereate) given doseamt \n data = dicentric") 
print(ggp)
```
And a plot for `doserate` as independent variable:
```{r,tidy=FALSE,fig.cap="Plot of predictions of model with doserate in normal scale"}
ggp <- ggplot(data = dicentric, mapping = aes(x = doserate, y = conc)) +
  geom_point(colour="blue") + 
  geom_line(colour="violet", mapping = aes(y=pred), size=1.2) +
  facet_wrap(facets = ~doseamt,nrow = 1) +
  ggtitle( "ca/cells vs. dosereate given doseamt \n data = dicentric")
print(ggp)
```

## Example: Skin cancer

### Data description

400 patients have been classified by cancer type and body site in which it has been detected.
The goal of analysis is to check if cancer type is independent from body site.

```{r,echo=FALSE}
rm(list=ls())
```
### Data loading
```{r}
data(skin)
head(skin)
str(skin)
```
### Descriptives
Data view as frequency table
```{r}
xtabs(Counts ~ Type + Site, data = skin)
```

A simple solution to answer to the main question is by using Pearson Chi-square test:
```{r}
chisq.test(matrix(skin$Counts,nrow=4,ncol=3))
```
The test says that there is no independence between cancer type and body site.

An alternative approach is to use models to conduct the same test, but with a likelihood (or deviance) approach.
Let us begin with main effects model using a Poisson-distributed dependent variable:
```{r}
fm0 <- glm(Counts ~ Type + Site, family = poisson(), data = skin)
summary(fm0)
```
If the main effects model is correct, and then no interaction between cancer type and body site exists, then the residual deviance will follow a Chi-square distribution with `df.residual` degrees of freedom.  
Now we test the model:
```{r}
1 - pchisq(fm0$deviance, fm0$df.residual)
```
p-value is very small: the model does not fit well the data, and probabily there is interaction between `Type` and `Site`.  
This confirms the above results obtained with Pearson Chi-square.

An alternative method to perform the same analysis is by estimate the saturated (full) model and then compare it with the main effects model with `anova()`.

```{r}
fm1 <- glm(Counts ~ Type * Site, family = poisson(), data = skin)
summary(fm1)
```
The comparison between fm0 and fm1
```{r}
anova(fm0, fm1, test="LRT")
```
Notice the use of `test="LRT"`; this is equivalent to  `test="Chisq"`.  
Not surprisingly, the results are equivalent to the results of analysis performed on residual deviance only.
The only difference with respect to previous test is that in this case a p-value on coefficients of interaction term is reported. This could allow the analyst (along with appropriate contrasts), to evaluate the combinations of levels that have greater impact on significancy of interaction term. 

Finally, if one thinks that the main effects model correctly describe the dependent variable, since an overdispersion exists in main effects model residuals, he/she could think to use quasi-poisson models to check the significancy of effects:
```{r}
fm2 <- glm(Counts ~ Type + Site, family = quasipoisson(), data = skin)
summary(fm2)

fm2a=glm(Counts ~ Type, family = quasipoisson(), data = skin)
anova(fm2,fm2a,test="F")
```
In this specific case, since the dispersion parameter is estimated, the `test="F"` option will be required for `anova()`.  
Notice that the parameter estimates of quasi-poisson model remain unchanged, with respect to Poisson model. Indeed, p-values of parameters and `anova()` change their values.

