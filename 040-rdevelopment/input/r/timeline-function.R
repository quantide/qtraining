timeline <-
function (df, events, label.col = names(df)[1], group.col = names(df)[2], 
          start.col = names(df)[3], end.col = names(df)[4], text.size = 4, 
          text.color = "black", num.label.steps = 5, event.label.col, 
          event.col, event.group.col, event.spots = 1, event.label = "", 
          event.label.method = 1, event.line = FALSE, event.text.size = 4, 
          event.above = TRUE, limits, label.col.hand, ...) 
{
  p <- ggplot()
  if (!missing(events)) {
    if (missing(event.label.col)) {
      event.label.col <- names(events)[1]
    }
    if (missing(event.col)) {
      event.col <- names(events)[2]
    }
    if (missing(event.group.col)) {
      event.group.col <- NULL
    }
  }
  else {
    event.spots <- 0
  }
  if (missing(limits)) {
    if (missing(events)) {
      limits <- range(c(df[, start.col], df[, end.col]), 
                      na.rm = TRUE)
    }
    else if (missing(df)) {
      limits <- range(events[, event.col], na.rm = TRUE)
    }
    else {
      limits <- range(c(df[, start.col], df[, end.col], 
                        events[, event.col]), na.rm = TRUE)
    }
  }
  groups <- unique(df[, group.col])
  xmin <- limits[1]
  xmax <- limits[2]
  ymin <- 0
  ymax <- length(groups)
  group.labels <- data.frame(group = groups, x = rep(xmin, 
                                                     length(groups)), y = rep(NA, length(groups)), stringsAsFactors = FALSE)
  df$ymin <- df$ymax <- df$n <- df$labelpos <- NA
  for (i in seq_along(groups)) {
    df[which(df[, group.col] == groups[i]), ]$n <- (rep(nrow(df[which(df[, group.col] == groups[i]), ]),nrow(df[which(df[, group.col] == groups[i]), ])))
    
    df[which(df[, group.col] == groups[i]), ]$ymin <- ifelse(event.above, 
                                                             0, event.spots - 1) + i - event.above
    df[which(df[, group.col] == groups[i]), ]$ymax <- ifelse(event.above, 
                                                             0, event.spots - 1) + i + (!event.above)
    group.labels[which(group.labels$group == groups[i]), 
                 ]$y <- ifelse(event.above, 0, event.spots - 1) + 
      i + (!event.above)
    
    df2 <- df[which(df[, group.col] == groups[i]), ] 
    
    
    df[which(df[, group.col] == groups[i]), ]$labelpos<- seq(unique(df2$ymin), unique(df2$ymax), length.out=unique(df2$n)+2)[2:(unique(df2$n)+1)]
  }
  print(df)
  
  if (!missing(events)) {
    if (num.label.steps > 1) {
      steps <- rev(seq(0, event.spots, by = event.spots/(num.label.steps + 
                                                           1))[2:(num.label.steps + 1)])
      events$y <- ifelse(event.above, ymax, 0) + rep(steps, 
                                                     ceiling(nrow(events)/length(steps)))[1:nrow(events)]
    }
    else {
      events$y <- ifelse(event.above, ymax, 0)
    }
  }
  group.labels <- rbind(group.labels, data.frame(group = event.label, 
                                                 x = xmin, y = ifelse(event.above, ymax + 1, 1)))
  df[df[, start.col] < xmin & df[, end.col] > xmin, start.col] <- xmin
  df[df[, end.col] > xmax & df[, start.col] < xmax, end.col] <- xmax
  if (!missing(events)) {
    events <- events[events[, event.col] >= xmin & events[, 
                                                          event.col] <= xmax, ]
    if (event.line) {
      p <- p + geom_segment(data = events, aes_string(x = event.col, 
                                                      xend = event.col, yend = "y"), y = ifelse(event.above, 
                                                                                                ymin, event.spots), alpha = 1)
    }
  }
  p <- p + geom_rect(data = df, aes_string(xmin = start.col, 
                                           xmax = end.col, ymin = "ymin", ymax = "ymax", fill = label.col.hand), 
                     alpha = 0.9) + geom_text(data = df, aes_string(y = "labelpos", 
                                                                    x = start.col, label = label.col), hjust = 0, size = text.size, 
                                              color = text.color) + theme(legend.position = "none", 
                                                                          axis.ticks.y = element_blank()) + xlab("") + ylab("") + 
    xlim(c(xmin, xmax)) + scale_y_continuous(breaks = group.labels$y - 
                                               0.5, labels = group.labels$group, limits = c(ymin, ymax + 
                                                                                              event.spots), minor_breaks = c())
  if (!missing(events)) {
    if (missing(event.group.col)) {
      events$Group <- "Group"
      event.group.col <- "Group"
    }
    if (event.label.method == 1) {
      p <- p + geom_point(data = events, aes_string(x = event.col, 
                                                    y = "y", color = event.group.col)) + geom_text(data = events, 
                                                                                                   aes_string(x = event.col, y = "y", label = event.label.col, 
                                                                                                              color = event.group.col), hjust = -0.05, size = event.text.size)
    }
    else if (event.label.method == 2) {
      p <- p + geom_point(data = events, aes_string(x = event.col, 
                                                    y = "y", color = event.group.col)) + geom_text(data = events, 
                                                                                                   aes_string(x = event.col, y = "y", label = event.label.col, 
                                                                                                              color = event.group.col), angle = 45, vjust = ifelse(event.above, 
                                                                                                                                                                   -0.15, 0), hjust = ifelse(event.above, -0.15, 
                                                                                                                                                                                             0), size = event.text.size)
    }
    else if (event.label.method == 3) {
      p <- p + geom_point(data = events, aes_string(x = event.col, 
                                                    y = "y", color = event.group.col)) + geom_text(data = events, 
                                                                                                   aes_string(x = event.col, label = event.label.col, 
                                                                                                              color = event.group.col, y = "y"), angle = 90, 
                                                                                                   hjust = ifelse(event.above, -0.15, 0.15), vjust = ifelse(event.above, 
                                                                                                                                                            0, 0), size = event.text.size)
    }
    if (length(unique(events[, event.group.col])) == 1) {
      p <- p + scale_color_grey()
    }
  }
  p <- p + geom_hline(yintercept = ifelse(event.above, 0, event.spots), 
                      size = 1)
  return(p)
}